<?php
class Password extends Data
{
	function __construct($con, $table)
	{
		$this->con=$con;
		$this->table=$table;
	}
	
	function encrypt($password, $data)
	{	
		$salt = substr(md5(mt_rand(), true), 8);
		$key = md5($password . $salt, true);
		$iv  = md5($key . $password . $salt, true);
		$ct = mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, $data, MCRYPT_MODE_CBC, $iv);

		return base64_encode('Salted__' . $salt . $ct);
	}

	function decrypt($password, $data)
	{
		$data = base64_decode($data);
		$salt = substr($data, 8, 8);
		$ct   = substr($data, 16);
		$key = md5($password . $salt, true);
		$iv  = md5($key . $password . $salt, true);
		$pt = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, $key, $ct, MCRYPT_MODE_CBC, $iv);
		return $pt;
	}
	
	function matchPassword($password, $login_id)
	{
		$rslt=$this::getData($this->con, "password", $this->table, array(login_id=>$login_id), "");
		$existing_encrypted_password=$rslt['detail'][0]['password'];
		
		$check_current_password=$this::decrypt($password, $existing_encrypted_password);
		unset($rslt['detail']);
		if(trim($check_current_password)==ENC_STRING)
		{
			$rslt["status"]=1;
			$rslt["msg"]="Password macthed";
		}
		else
		{
			$rslt["status"]=0;
			$rslt["msg"]="Your current password is incorrect";
		}
		return($rslt);
	}
	
	function changePasswordWithMatchCurrent($current_password, $new_password, $login_id)
	{
		$rslt=$this::matchPassword($current_password, $login_id);
		if($rslt['status']==1)
		{
			//print_r($rslt);
			$new_encrypted_password=$this::encrypt($new_password, ENC_STRING);
			$this->con->query("UPDATE ".$this->table." SET password='$new_encrypted_password' WHERE login_id='$login_id'");
			if(!$this->con->error)
			{
				$rslt['status']=1;
				$rslt['msg']="Password has been changed. Please login again";
			}
			else
			{
				$rslt['status']=0;
				$rslt['msg']=$this->con->error;
			}
		}
		return($rslt);
	}
	
	function changePassword($new_password, $login_id)
	{
		$new_encrypted_password=$this::encrypt($new_password, ENC_STRING);
		$this->con->query("UPDATE ".$this->table." SET password='$new_encrypted_password' WHERE login_id='$login_id'");
		if(!$this->con->error)
		{
			$rslt['status']=1;
			$rslt['msg']="Password has been changed. Please login again";
		}
		else
		{
			$rslt['status']=0;
			$rslt['msg']=$this->con->error;
		}
		return($rslt);
	}
}
?>